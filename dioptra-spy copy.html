<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dioptra Spy</title>

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìç</text></svg>"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />

    <style>
      :root {
        --header-height: 50px;
        --sidebar-width: 320px;
        --inspector-width: 350px;
        --bg-color: #f8f9fa;
        --border-color: #dee2e6;
        --text-color: #212529;
        --primary-color: #0d6efd;
        --white: #fff;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        --tran-speed: 0.3s;
      }
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        overflow: hidden;
        background-color: var(--bg-color);
      }
      #header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--header-height);
        background: var(--white);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
        z-index: 1001;
      }

      /* Left Sidebar */
      #sidebar {
        position: fixed;
        top: var(--header-height);
        left: 0;
        width: var(--sidebar-width);
        height: calc(100% - var(--header-height));
        background: var(--white);
        border-right: 1px solid var(--border-color);
        z-index: 1000;
        transform: translateX(calc(-1 * var(--sidebar-width)));
        transition: transform var(--tran-speed) ease;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      #sidebar.open {
        transform: translateX(0);
      }

      /* Main Content Area */
      #main-content {
        width: 100%;
        height: 100%;
        padding-top: var(--header-height);
        box-sizing: border-box;
        position: relative;
        transition: padding-left var(--tran-speed) ease,
          padding-right var(--tran-speed) ease;
      }
      #sidebar.open ~ #main-content {
        padding-left: var(--sidebar-width);
      }
      #inspector.open ~ #main-content {
        padding-right: var(--inspector-width);
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #map.pin-drop-mode {
        cursor: crosshair;
      }

      /* Right Inspector Panel */
      #inspector {
        position: fixed;
        top: var(--header-height);
        right: 0;
        width: var(--inspector-width);
        height: calc(100% - var(--header-height));
        background: var(--white);
        border-left: 1px solid var(--border-color);
        z-index: 1000;
        transform: translateX(var(--inspector-width));
        transition: transform var(--tran-speed) ease;
        display: flex;
        flex-direction: column;
      }
      #inspector.open {
        transform: translateX(0);
      }
      #inspector-content {
        padding: 20px;
        flex-grow: 1;
        overflow-y: auto;
      }
      #inspector-placeholder {
        color: #6c757d;
        text-align: center;
        padding-top: 50px;
      }
      #details-thumbnail {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-bottom: 20px;
        object-fit: cover;
      }
      .inspector-group {
        margin-bottom: 20px;
      }
      .inspector-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
      }
      .inspector-group input,
      .inspector-group textarea {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 10px;
        font-family: inherit;
        font-size: 14px;
        resize: none;
      }
      #details-notes {
        resize: vertical;
        min-height: 150px;
      }

      /* Other Components */
      .header-left,
      .header-right {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .logo {
        font-size: 1.2rem;
        font-weight: 600;
      }
      .logo span {
        color: var(--primary-color);
      }
      .icon-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        display: inline-flex;
        transition: background-color 0.2s;
      }
      .icon-button:hover {
        background-color: var(--border-color);
      }
      .material-symbols-outlined {
        vertical-align: middle;
        font-size: 20px;
      }
      .action-button {
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background-color 0.2s;
      }
      .action-button:hover {
        background-color: #e2e6ea;
      }

      /* Collapsible Sidebar Sections */
      .sidebar-section {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
      }
      .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .collapsible-header h3 {
        margin: 0;
        font-size: 1rem;
      }
      .collapse-icon {
        transition: transform var(--tran-speed) ease;
      }
      .collapsible-content {
        max-height: 500px; /* A large value for expansion */
        overflow: hidden;
        transition: max-height var(--tran-speed) ease-out,
          padding var(--tran-speed) ease-out;
        padding-top: 10px;
      }
      .collapsed .collapsible-content {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
      }
      .collapsed .collapse-icon {
        transform: rotate(-90deg);
      }

      #filter-input {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
      }
      #filter-results-count {
        font-size: 12px;
        color: #6c757d;
        margin-top: 8px;
      }
      .image-list-container {
        overflow-y: auto;
        max-height: 20vh;
      }
      .image-list-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .image-list-item:hover,
      .image-list-item.selected {
        background-color: #e9ecef;
      }
      .image-list-item img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
      }
      .image-list-item .info {
        font-size: 13px;
        line-height: 1.3;
        overflow: hidden;
        flex-grow: 1;
      }
      .image-list-item .filename {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .image-list-item .details {
        font-size: 11px;
        color: #6c757d;
      }
      .locate-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .locate-button:hover {
        background-color: #0b5ed7;
      }
      #general-notes {
        width: 100%;
        box-sizing: border-box;
        resize: none;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px;
        font-family: inherit;
        font-size: 14px;
        min-height: 120px;
      }
      .leaflet-popup-content {
        font-size: 13px;
      }
      .user-message {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1002;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        font-size: 14px;
        text-align: center;
        max-width: 80%;
      }
      .user-message.error {
        background: rgba(220, 53, 69, 0.9);
      }
      .user-message.info {
        background: rgba(13, 110, 253, 0.9);
      }
      #drop-zone {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 123, 255, 0.1);
        border: 3px dashed var(--primary-color);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
        pointer-events: none;
      }
      #drop-zone.visible {
        display: flex;
      }
    </style>
  </head>
  <body>
    <header id="header">
      <div class="header-left">
        <button id="sidebar-toggle" class="icon-button" title="Toggle Sidebar">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <div class="logo">Dioptra<span>Spy</span></div>
      </div>
      <div class="header-right">
        <button class="action-button" id="save-session-btn">
          <span class="material-symbols-outlined">save</span> Save
        </button>
        <button class="action-button" id="load-session-btn">
          <span class="material-symbols-outlined">folder_open</span> Load
        </button>
      </div>
    </header>

    <aside id="sidebar">
      <div class="sidebar-section">
        <input
          type="text"
          id="filter-input"
          placeholder="Filter by title, notes, date..."
        />
        <div id="filter-results-count"></div>
      </div>
      <div class="sidebar-section collapsible" id="geolocated-section">
        <div class="collapsible-header">
          <h3>Geolocated Images</h3>
          <span class="collapse-icon material-symbols-outlined"
            >expand_less</span
          >
        </div>
        <div class="collapsible-content">
          <div id="geolocated-list" class="image-list-container"></div>
        </div>
      </div>
      <div class="sidebar-section collapsible" id="unlocated-section">
        <div class="collapsible-header">
          <h3>Unlocated Images</h3>
          <span class="collapse-icon material-symbols-outlined"
            >expand_less</span
          >
        </div>
        <div class="collapsible-content">
          <div id="unlocated-list" class="image-list-container"></div>
        </div>
      </div>
      <div class="sidebar-section collapsible" id="general-notes-section">
        <div class="collapsible-header">
          <h3>General Case Notes</h3>
          <span class="collapse-icon material-symbols-outlined"
            >expand_less</span
          >
        </div>
        <div class="collapsible-content">
          <textarea
            id="general-notes"
            placeholder="Overall summary, to-do list..."
          ></textarea>
        </div>
      </div>
    </aside>

    <aside id="inspector">
      <div id="inspector-content">
        <div id="inspector-placeholder">Select a pin to see its details.</div>
        <div id="inspector-details" style="display: none">
          <img id="details-thumbnail" src="" alt="Selected image thumbnail" />
          <div class="inspector-group">
            <label for="details-title">Custom Title</label>
            <input
              type="text"
              id="details-title"
              placeholder="e.g., Main Entrance - North View"
            />
          </div>
          <div class="inspector-group">
            <label for="details-datetime">Date/Time</label>
            <input
              type="text"
              id="details-datetime"
              placeholder="YYYY:MM:DD HH:MM:SS"
            />
          </div>
          <div class="inspector-group">
            <label for="details-model">Camera Model</label>
            <input
              type="text"
              id="details-model"
              placeholder="e.g., iPhone 15 Pro"
            />
          </div>
          <div class="inspector-group">
            <label for="details-notes">Pin Notes</label>
            <textarea
              id="details-notes"
              placeholder="Enter notes for this specific pin..."
            ></textarea>
          </div>
        </div>
      </div>
    </aside>

    <main id="main-content">
      <div id="map"></div>
      <div id="drop-zone"><div id="drop-zone-text">Drop Images Here</div></div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let currentImageData = [];
        let itemPendingPlacement = null;
        let selectedItemId = null;

        const ui = {
          sidebar: document.getElementById("sidebar"),
          sidebarToggle: document.getElementById("sidebar-toggle"),
          saveBtn: document.getElementById("save-session-btn"),
          loadBtn: document.getElementById("load-session-btn"),
          geolocatedList: document.getElementById("geolocated-list"),
          unlocatedList: document.getElementById("unlocated-list"),
          dropZone: document.getElementById("drop-zone"),
          mainContent: document.getElementById("main-content"),
          map: document.getElementById("map"),
          inspector: document.getElementById("inspector"),
          inspectorPlaceholder: document.getElementById(
            "inspector-placeholder"
          ),
          inspectorDetails: document.getElementById("inspector-details"),
          detailsThumbnail: document.getElementById("details-thumbnail"),
          detailsTitle: document.getElementById("details-title"),
          detailsDatetime: document.getElementById("details-datetime"),
          detailsModel: document.getElementById("details-model"),
          detailsNotes: document.getElementById("details-notes"),
          filterInput: document.getElementById("filter-input"),
          filterResultsCount: document.getElementById("filter-results-count"),
          generalNotes: document.getElementById("general-notes"),
        };

        ui.sidebarToggle.addEventListener("click", () => {
          ui.sidebar.classList.toggle("open");
          ui.mainContent.style.paddingLeft = ui.sidebar.classList.contains(
            "open"
          )
            ? "var(--sidebar-width)"
            : "0";
        });
        ui.saveBtn.addEventListener("click", saveSession);
        ui.loadBtn.addEventListener("click", loadSession);
        ui.filterInput.addEventListener("input", () => updateUI());

        const map = L.map(ui.map, { zoomControl: false }).setView([20, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);
        L.control.zoom({ position: "bottomright" }).addTo(map);
        const markersLayer = L.markerClusterGroup();
        map.addLayer(markersLayer);

        ui.sidebar.addEventListener("transitionend", () =>
          map.invalidateSize()
        );
        ui.inspector.addEventListener("transitionend", () =>
          map.invalidateSize()
        );
        map.on("click", deselectAll);

        [
          "details-title",
          "details-datetime",
          "details-model",
          "details-notes",
        ].forEach((id) => {
          document.getElementById(id).addEventListener("input", () => {
            if (selectedItemId) saveInspectorDetails(selectedItemId);
          });
        });

        ui.mainContent.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.stopPropagation();
          ui.dropZone.classList.add("visible");
        });
        ui.mainContent.addEventListener("dragleave", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (
            e.relatedTarget === null ||
            !ui.mainContent.contains(e.relatedTarget)
          ) {
            ui.dropZone.classList.remove("visible");
          }
        });
        ui.mainContent.addEventListener("drop", (e) => {
          e.preventDefault();
          e.stopPropagation();
          ui.dropZone.classList.remove("visible");
          if (e.dataTransfer.files.length > 0)
            processFiles(e.dataTransfer.files);
        });

        function setupCollapsibleSections() {
          const savedState =
            JSON.parse(localStorage.getItem("dioptraSidebarState")) || {};
          ui.sidebar.addEventListener("click", (e) => {
            const header = e.target.closest(".collapsible-header");
            if (header) {
              const section = header.closest(".sidebar-section.collapsible");
              if (section) {
                section.classList.toggle("collapsed");
                savedState[section.id] =
                  section.classList.contains("collapsed");
                localStorage.setItem(
                  "dioptraSidebarState",
                  JSON.stringify(savedState)
                );
              }
            }
          });
          document
            .querySelectorAll(".sidebar-section.collapsible")
            .forEach((section) => {
              if (savedState[section.id] === true) {
                section.classList.add("collapsed");
              }
            });
        }

        async function processFiles(files) {
          const geolocatedFiles = [];
          const unlocatedFiles = [];
          for (const file of files) {
            if (!file.type.startsWith("image/")) continue;
            const newImageBase = {
              id: Date.now() + Math.random(),
              title: "",
              notes: "",
              original_path: file.name,
              datetime: "N/A",
              model: "N/A",
              thumbnail_rel_path: await createThumbnail(file),
            };
            try {
              const tags = await getExifData(file);
              const gps = getGpsData(tags);
              currentImageData.push({
                ...newImageBase,
                latitude: gps.lat,
                longitude: gps.lon,
                datetime: tags.DateTimeOriginal || "N/A",
                model: tags.Model || "N/A",
              });
              geolocatedFiles.push(file.name);
            } catch (error) {
              currentImageData.push({
                ...newImageBase,
                latitude: null,
                longitude: null,
              });
              unlocatedFiles.push(file.name);
            }
          }
          let message = `Processed ${files.length} file(s). `;
          if (geolocatedFiles.length > 0)
            message += `${geolocatedFiles.length} geolocated. `;
          if (unlocatedFiles.length > 0)
            message += `${unlocatedFiles.length} sent to 'Unlocated'.`;
          displayMessage(message, "info");
          updateUI();
        }

        function updateUI() {
          const filterTerm = ui.filterInput.value.toLowerCase();
          const filteredData = currentImageData.filter((item) => {
            if (!filterTerm) return true;
            const displayTitle = item.title || item.original_path;
            return (
              displayTitle.toLowerCase().includes(filterTerm) ||
              (item.notes && item.notes.toLowerCase().includes(filterTerm)) ||
              (item.datetime &&
                item.datetime.toLowerCase().includes(filterTerm)) ||
              (item.model && item.model.toLowerCase().includes(filterTerm))
            );
          });
          populateMap(filteredData);
          populateSidebar(filteredData);
          if (filterTerm) {
            ui.filterResultsCount.textContent = `Showing ${filteredData.length} of ${currentImageData.length} items.`;
          } else {
            ui.filterResultsCount.textContent = `Total items: ${currentImageData.length}`;
          }
        }

        function populateMap(imageData) {
          markersLayer.clearLayers();
          const geolocated = imageData.filter(
            (item) => item.latitude !== null && item.longitude !== null
          );
          geolocated.forEach((item) => {
            const displayTitle =
              item.title || item.original_path.split(/[\\/]/).pop();
            const popupContent = `<b>${displayTitle}</b><br><small>Click pin for details</small>`;
            const marker = L.marker([item.latitude, item.longitude], {
              draggable: true,
            }).bindPopup(popupContent);
            marker.on("click", (e) => {
              L.DomEvent.stopPropagation(e);
              selectItem(item.id);
            });
            marker.on("dragstart", function (event) {
              this._originalLatLng = event.target.getLatLng();
            });
            marker.on("dragend", function (event) {
              const marker = event.target,
                originalPos = this._originalLatLng,
                newPos = marker.getLatLng();
              const confirmation = window.confirm(
                `Are you sure you want to move this pin?`
              );
              if (confirmation) {
                item.latitude = newPos.lat;
                item.longitude = newPos.lng;
                displayMessage(`Updated location for ${displayTitle}.`, "info");
              } else {
                marker.setLatLng(originalPos);
              }
            });
            item.marker = marker;
            markersLayer.addLayer(marker);
          });
        }

        function populateSidebar(imageData) {
          ui.geolocatedList.innerHTML = "";
          ui.unlocatedList.innerHTML = "";
          const sortedData = [...imageData].sort((a, b) => {
            if (a.latitude === null && b.latitude !== null) return -1;
            if (a.latitude !== null && b.latitude === null) return 1;
            return a.original_path.localeCompare(b.original_path);
          });
          sortedData.forEach((item) => {
            const listItem = document.createElement("div");
            listItem.className = "image-list-item";
            listItem.dataset.itemId = String(item.id);
            const displayTitle =
              item.title || item.original_path.split(/[\\/]/).pop();
            if (item.latitude !== null) {
              listItem.innerHTML = `<img src="${item.thumbnail_rel_path}" alt="thumb"><div class="info"><div class="filename">${displayTitle}</div><div class="details">${item.datetime}</div></div>`;
              listItem.addEventListener("click", (e) => {
                e.stopPropagation();
                selectItem(item.id);
              });
              if (item.id === selectedItemId)
                listItem.classList.add("selected");
              ui.geolocatedList.appendChild(listItem);
            } else {
              listItem.innerHTML = `<img src="${item.thumbnail_rel_path}" alt="thumb"><div class="info"><div class="filename">${displayTitle}</div></div><button class="locate-button">Locate</button>`;
              listItem
                .querySelector(".locate-button")
                .addEventListener("click", (e) => {
                  e.stopPropagation();
                  startPinDrop(item.id);
                });
              ui.unlocatedList.appendChild(listItem);
            }
          });
        }

        function selectItem(itemId) {
          if (selectedItemId && selectedItemId !== itemId)
            saveInspectorDetails(selectedItemId);
          selectedItemId = itemId;
          const item = currentImageData.find((i) => i.id === itemId);
          if (item) {
            ui.inspectorPlaceholder.style.display = "none";
            ui.inspectorDetails.style.display = "block";
            ui.detailsThumbnail.src = item.thumbnail_rel_path;
            ui.detailsThumbnail.alt = `Thumbnail for ${item.original_path}`;
            ui.detailsTitle.value = item.title || "";
            ui.detailsDatetime.value = item.datetime || "";
            ui.detailsModel.value = item.model || "";
            ui.detailsNotes.value = item.notes || "";
            ui.inspector.classList.add("open");
            ui.mainContent.style.paddingRight = "var(--inspector-width)";
            if (item.marker) {
              markersLayer.zoomToShowLayer(item.marker, () => {
                item.marker.openPopup();
              });
            }
          }
          document
            .querySelectorAll(".image-list-item.selected")
            .forEach((el) => el.classList.remove("selected"));
          const listItem = document.querySelector(`[data-item-id='${itemId}']`);
          if (listItem) listItem.classList.add("selected");
        }

        function deselectAll() {
          if (selectedItemId) {
            saveInspectorDetails(selectedItemId);
            selectedItemId = null;
            ui.inspector.classList.remove("open");
            ui.mainContent.style.paddingRight = "0";
            ui.inspectorPlaceholder.style.display = "block";
            ui.inspectorDetails.style.display = "none";
            document
              .querySelectorAll(".image-list-item.selected")
              .forEach((el) => el.classList.remove("selected"));
          }
        }

        function saveInspectorDetails(itemId) {
          const item = currentImageData.find((i) => i.id === itemId);
          if (item) {
            item.title = ui.detailsTitle.value;
            item.datetime = ui.detailsDatetime.value;
            item.model = ui.detailsModel.value;
            item.notes = ui.detailsNotes.value;
            // Also update the sidebar in real-time as you type
            const listItem = document.querySelector(
              `[data-item-id='${itemId}'] .filename`
            );
            if (listItem)
              listItem.textContent =
                item.title || item.original_path.split(/[\\/]/).pop();
          }
        }

        function startPinDrop(itemId) {
          if (itemPendingPlacement) {
            displayMessage("Already in pin-drop mode.", "info");
            return;
          }
          itemPendingPlacement = currentImageData.find(
            (item) => item.id === itemId
          );
          if (!itemPendingPlacement) return;
          ui.map.classList.add("pin-drop-mode");
          displayMessage(
            "Click map to place pin. Press ESC to cancel.",
            "info"
          );
          map.once("click", handlePinDrop);
          document.addEventListener("keydown", cancelPinDropOnEsc);
        }
        function handlePinDrop(e) {
          if (!itemPendingPlacement) return;
          itemPendingPlacement.latitude = e.latlng.lat;
          itemPendingPlacement.longitude = e.latlng.lng;
          finishPinDrop(`Image pin placed.`);
        }
        function cancelPinDropOnEsc(e) {
          if (e.key === "Escape") {
            finishPinDrop("Pin placement cancelled.");
          }
        }
        function finishPinDrop(message) {
          ui.map.classList.remove("pin-drop-mode");
          displayMessage(message, "info");
          itemPendingPlacement = null;
          map.off("click", handlePinDrop);
          document.removeEventListener("keydown", cancelPinDropOnEsc);
          updateUI();
        }

        function saveSession() {
          if (selectedItemId) saveInspectorDetails(selectedItemId);
          const sessionData = {
            version: "1.2",
            createdAt: new Date().toISOString(),
            imageData: currentImageData.map(({ marker, ...rest }) => rest),
            generalNotes: ui.generalNotes.value,
          };
          const dataStr = JSON.stringify(sessionData, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `dioptra-case-${new Date()
            .toISOString()
            .slice(0, 10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
          displayMessage("Session saved.", "info");
        }

        function loadSession() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".json";
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const data = JSON.parse(event.target.result);
                if (!data.imageData) throw new Error("Invalid session file.");
                loadSessionData(data);
                displayMessage("Session loaded.", "info");
              } catch (err) {
                displayMessage("Error reading file.", "error");
              }
            };
            reader.readAsText(file);
          };
          input.click();
        }

        function loadSessionData(sessionData) {
          currentImageData = sessionData.imageData.map((item) => ({
            ...item,
            title: item.title || "",
            notes: item.notes || "",
          }));
          ui.generalNotes.value = sessionData.generalNotes || "";
          ui.filterInput.value = "";
          deselectAll();
          updateUI();
        }

        async function loadInitialData() {
          try {
            const response = await fetch("output/data.json");
            if (response.ok) {
              const data = await response.json();
              loadSessionData({
                imageData: data.map((item) => ({
                  ...item,
                  id: Date.now() + Math.random(),
                  title: "",
                  notes: "",
                })),
                generalNotes: "",
              });
            } else {
              throw new Error("No initial data file.");
            }
          } catch (error) {
            displayMessage(
              "Ready. Drag images or load a session file.",
              "info"
            );
          }
        }

        function displayMessage(message, type = "info", duration = 4000) {
          const existingMsg = document.querySelector(".user-message");
          if (existingMsg) existingMsg.remove();
          const msgDiv = document.createElement("div");
          msgDiv.className = `user-message ${type}`;
          msgDiv.innerHTML = message;
          ui.mainContent.appendChild(msgDiv);
          setTimeout(() => {
            msgDiv.remove();
          }, duration);
        }
        function getExifData(file) {
          return new Promise((resolve, reject) => {
            EXIF.getData(file, function () {
              const tags = EXIF.getAllTags(this);
              if (Object.keys(tags).length === 0) {
                reject(new Error("No EXIF data."));
              } else {
                resolve(tags);
              }
            });
          });
        }
        function getGpsData(tags) {
          if (!tags.GPSLatitude || !tags.GPSLongitude) {
            throw new Error("GPS data not found.");
          }
          const latRef = tags.GPSLatitudeRef || "N";
          const lonRef = tags.GPSLongitudeRef || "E";
          const lat =
            (tags.GPSLatitude[0] +
              tags.GPSLatitude[1] / 60 +
              tags.GPSLatitude[2] / 3600) *
            (latRef === "N" ? 1 : -1);
          const lon =
            (tags.GPSLongitude[0] +
              tags.GPSLongitude[1] / 60 +
              tags.GPSLongitude[2] / 3600) *
            (lonRef === "E" ? 1 : -1);
          return { lat, lon };
        }
        function createThumbnail(file, maxWidth = 200, maxHeight = 200) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement("canvas");
                let { width, height } = img;
                if (width > height) {
                  if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                  }
                } else {
                  if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                  }
                }
                canvas.width = width;
                canvas.height = height;
                canvas.getContext("2d").drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL("image/jpeg"));
              };
              img.onerror = reject;
              img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsText(file);
          });
        }

        // --- Kick everything off ---
        setupCollapsibleSections();
        loadInitialData();
      });
    </script>
  </body>
</html>
